name: Deploy Fullstack (Fixed Build)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  # 1. DEPLOY BACKEND (C·∫ßn Build ra DLL tr∆∞·ªõc)
  deploy-backend-somee:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # B∆∞·ªõc c√†i ƒë·∫∑t .NET (Quan tr·ªçng)
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x" # N·∫øu project b·∫°n d√πng .NET 6 ho·∫∑c 7 th√¨ s·ª≠a s·ªë n√†y

      # B∆∞·ªõc "N·∫•u ch√≠n" code (Build ra th∆∞ m·ª•c publish)
      - name: Publish .NET App
        run: dotnet publish -c Release -o ./publish_output

      # Upload s·∫£n ph·∫©m ƒë√£ n·∫•u (trong folder publish_output) l√™n Somee
      - name: üöÄ Sync Backend to Somee
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.SOMEE_FTP_SERVER }}
          username: ${{ secrets.SOMEE_FTP_USER }}
          password: ${{ secrets.SOMEE_FTP_PASS }}
          local-dir: ./publish_output/ # Ch·ªâ l·∫•y file ƒë√£ bi√™n d·ªãch
          server-dir: /

  # 2. DEPLOY FRONTEND (Gi·ªØ nguy√™n)
  deploy-frontend-infinity:
    runs-on: ubuntu-latest
    needs: deploy-backend-somee # Ch·∫°y xong backend m·ªõi ch·∫°y frontend (t√πy ch·ªçn)
    steps:
      - uses: actions/checkout@v4
      - name: üöÄ Sync Frontend to InfinityFree
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.IF_HOST }}
          username: ${{ secrets.IF_USER }}
          password: ${{ secrets.IF_PASS }}
          local-dir: ./wwwroot/
          server-dir: htdocs/
          dangerous-clean-slate: false
